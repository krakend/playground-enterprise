<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KrakenD WebSocket Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel=icon type=image/png href=https://www.krakend.io/favicon/favicon-196x196.png sizes=196x196>
    <link rel=icon type=image/png href=https://www.krakend.io/favicon/favicon-96x96.png sizes=96x96>
    <link rel=icon type=image/png href=https://www.krakend.io/favicon/favicon-32x32.png sizes=32x32>
    <link rel=icon type=image/png href=https://www.krakend.io/favicon/favicon-16x16.png sizes=16x16>
    <link rel=icon type=image/png href=https://www.krakend.io/favicon/favicon-128.png sizes=128x128>
</head>

<body class="bg-gray-900 text-gray-100">
<header class="container mx-auto flex justify-between items-center py-4 px-3">
    <h1 class="text-xl font-bold">
        <a href="/" class="flex items-center no-underline">
            <img src="https://www.krakend.io/images/logo-krakend.svg" width="157" height="31" alt="KrakenD API Gateway">
            <span class="ml-3">WebSocket Chat Demo</span>
        </a>
    </h1>
    <a href="https://github.com/krakend/playground-enterprise" target="_blank" rel="noopener" class="text-blue-600 hover:underline flex items-center">
        Go to Playground
        <svg class="inline-block ml-1 h-6 w-6" viewBox="0 0 24 24">
            <path d="M12 0c6.628.0 12 5.508 12 12.304.0 5.434-3.434 10.045-8.2 11.673-.608.121-.824-.263-.824-.59.0-.406.014-1.73.014-3.377.0-1.147-.384-1.896-.814-2.278 2.672-.304 5.48-1.345 5.48-6.07.0-1.344-.466-2.441-1.236-3.303.125-.31.536-1.562-.118-3.257.0.0-1.005-.33-3.296 1.262A11.275 11.275.0 0012 5.95a11.25 11.25.0 00-3.004.414c-2.293-1.592-3.3-1.262-3.3-1.262-.652 1.695-.24 2.946-.117 3.257-.767.862-1.236 1.959-1.236 3.303.0 4.713 2.802 5.77 5.467 6.08-.343.307-.654.85-.762 1.645-.684.315-2.422.858-3.492-1.022.0.0-.635-1.182-1.84-1.269.0.0-1.17-.015-.081.748.0.0.786.378 1.332 1.8.0.0.704 2.196 4.043 1.452.006 1.028.016 1.998.016 2.29.0.326-.22.706-.82.592C3.439 22.352.0 17.74.0 12.304.0 5.508 5.374.0 12 0"
                  fill="currentcolor" fill-rule="nonzero"></path>
        </svg>
    </a>
</header>

<nav class="bg-gradient-to-r from-violet-500 to-blue-500 py-2">
    <div class="container mx-auto flex justify-between items-center px-3">
        <ul class="flex space-x-4">
            <li><a id="roomlink" href="#" class="text-white font-medium hover:underline flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6 mr-1">
                    <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
                </svg>
                Room: <span id="id_roomname" class="font-bold ml-1">foo</span>
            </a></li>
        </ul>
        <span class="text-white">
            <a href="https://www.krakend.io/docs/enterprise/websockets/" target="_blank" class="hover:underline flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6 mr-1">
                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.75a.75.75 0 01-1.5 0v-.75c0-1.279 1.06-2.107 1.875-2.502.182-.088.351-.199.503-.331.83-.727.83-1.857 0-2.584zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                </svg>
                WebSockets Docs
            </a>
        </span>
    </div>
</nav>

<div class="container mx-auto py-4 px-3">
    <div class="w-full">
        <div class="rounded-md bg-blue-50 p-4 my-4">
            <div class="flex">
                <div class="shrink-0">
                    <svg class="size-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3 flex-1 md:flex md:justify-between">
                    <p class="text-sm text-blue-700">This is a WebSocket chat demo using KrakenD's WebSocket proxy feature. Type your message below and press Enter to send.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-6 mb-6">
        <div class="w-full">
            <div class="text-lg font-semibold mb-3">
                <div class="flex justify-between">
                    <div>Chat Messages</div>
                    <div class="text-sm text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="inline align-text-bottom h-5 w-5">
                            <path fill-rule="evenodd" d="M12 2.25c-2.429 0-4.817.178-7.152.521C2.87 3.061 1.5 4.795 1.5 6.741v6.018c0 1.946 1.37 3.68 3.348 3.97.877.129 1.761.234 2.652.316V21a.75.75 0 0 0 1.28.53l4.184-4.183a.39.39 0 0 1 .266-.112c2.006-.05 3.982-.22 5.922-.506 1.978-.29 3.348-2.023 3.348-3.97V6.741c0-1.947-1.37-3.68-3.348-3.97A49.145 49.145 0 0 0 12 2.25ZM8.25 8.625a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Zm2.625 1.125a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.5-1.125a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Z" clip-rule="evenodd" />
                        </svg>
                        Connected to <span id="connection_status" class="font-medium text-green-400">ws://localhost:8080/chat/ws/<span id="room_display">foo</span></span>
                    </div>
                </div>
            </div>
            <pre id="chat" class="bg-gray-800 text-gray-100 p-4 rounded-md h-96 overflow-y-auto"></pre>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-6">
        <div class="w-full">
            <div class="flex w-full">
                <input id="text" placeholder="Type your message and press Enter" class="w-full px-4 py-2 border border-gray-600 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>
    </div>
</div>

<hr class="my-8 border-gray-700">

<footer class="text-center text-gray-600 pb-6">
    <p>Made with <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-red-500 inline align-bottom h-5 w-5">
        <path d="m9.653 16.915-.005-.003-.019-.01a20.759 20.759 0 0 1-1.162-.682 22.045 22.045 0 0 1-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 0 1 8-2.828A4.5 4.5 0 0 1 18 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 0 1-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 0 1-.69.001l-.002-.001Z" />
    </svg>
        by KrakenD team</p>
    <p>
        <a href="https://www.krakend.io/" target="_blank" class="hover:underline">Website</a> | <a href="https://www.krakend.io/docs/" target="_blank" class="hover:underline">Docs</a> | <a href="https://github.com/krakend/playground-community" target="_blank" class="hover:underline">Playground community</a>
    </p>
</footer>

<script>
    var room = 'foo'
    if(window.location.search.length > 0) {
        // select the room with the room query param
        try {
            // Use URLSearchParams for safer URL parameter handling
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if(roomParam && roomParam.trim().length > 0) {
                // Apply length restriction as additional security measure
                room = roomParam.trim().substring(0, 50); // Limit to 50 chars
            }
        } catch (e) {
            console.error("Error parsing URL parameters:", e);
        }
    }

    // Update room display - using textContent instead of innerHTML for security
    document.getElementById("id_roomname").textContent = room;
    document.getElementById("room_display").textContent = room;

    // Create join another room link
    document.getElementById("roomlink").addEventListener('click', function() {
        let newRoom = prompt("Enter a room name to join:", room);
        if(newRoom && newRoom.trim() !== '') {
            // Use encodeURIComponent to safely encode parameters in URLs
            window.location.href = `?room=${encodeURIComponent(newRoom.trim())}`;
        }
    });

    // use the subdir for the ws connection
    var url = "ws://" + window.location.host + window.location.pathname;
    if(!url.endsWith('/')) {
        url = url + '/';
    }
    // Use encodeURIComponent to safely encode the room parameter
    url = url + 'ws/' + encodeURIComponent(room);

    var ws = new WebSocket(url);
    var name = "Guest" + Math.floor(Math.random() * 1000);

    var chat = document.getElementById("chat");
    var text = document.getElementById("text");
    var connectionStatus = document.getElementById("connection_status");

    var now = function() {
        var iso = new Date().toISOString();
        return iso.split("T")[1].split(".")[0];
    };

    ws.onopen = function() {
        connectionStatus.classList.remove("text-red-400");
        connectionStatus.classList.add("text-green-400");
        appendMessage("System", `Connected to chat room '${room}'`);
    };

    ws.onclose = function() {
        connectionStatus.classList.remove("text-green-400");
        connectionStatus.classList.add("text-red-400");
        appendMessage("System", "Disconnected from chat server");
    };

    ws.onerror = function() {
        connectionStatus.classList.remove("text-green-400");
        connectionStatus.classList.add("text-red-400");
        appendMessage("System", "Error connecting to chat server");
    };

    ws.onmessage = function(msg) {
        var timestamp = now();
        var messageText = msg.data;
        
        // Create safe DOM elements instead of using innerHTML
        var messageContainer = document.createElement('div');
        
        // Create timestamp element
        var timestampSpan = document.createElement('span');
        timestampSpan.className = "text-gray-400";
        timestampSpan.textContent = `[${timestamp}]`;
        messageContainer.appendChild(timestampSpan);
        messageContainer.appendChild(document.createTextNode(' '));
        
        // Check if message contains a username format <Username>
        var usernameMatch = messageText.match(/^<([^>]+)>\s(.*)/);
        if (usernameMatch) {
            // Format with username highlighted
            var username = usernameMatch[1];
            var content = usernameMatch[2];
            
            // Add username element
            var usernameSpan = document.createElement('span');
            usernameSpan.className = "text-blue-400";
            usernameSpan.textContent = `${username}:`;
            messageContainer.appendChild(usernameSpan);
            messageContainer.appendChild(document.createTextNode(' ' + content));
        } else {
            // System message or non-standard format
            messageContainer.appendChild(document.createTextNode(messageText));
        }
        
        // Add the new line
        chat.appendChild(messageContainer);
        chat.appendChild(document.createTextNode('\n'));
        chat.scrollTop = chat.scrollHeight;
    };

    text.onkeydown = function(e) {
        if(e.keyCode === 13 && text.value !== "") {
            ws.send("<" + name + "> " + text.value);
            text.value = "";
        }
    };

    function appendMessage(sender, message) {
        var timestamp = now();
        
        // Create safe DOM elements instead of using innerHTML
        var messageContainer = document.createElement('div');
        
        // Create timestamp element
        var timestampSpan = document.createElement('span');
        timestampSpan.className = "text-gray-400";
        timestampSpan.textContent = `[${timestamp}]`;
        messageContainer.appendChild(timestampSpan);
        messageContainer.appendChild(document.createTextNode(' '));
        
        if (sender) {
            // Add sender element
            var senderSpan = document.createElement('span');
            senderSpan.className = "text-blue-400";
            senderSpan.textContent = `${sender}:`;
            messageContainer.appendChild(senderSpan);
            messageContainer.appendChild(document.createTextNode(' ' + message));
        } else {
            // Just the message
            messageContainer.appendChild(document.createTextNode(message));
        }
        
        // Add the new line
        chat.appendChild(messageContainer);
        chat.appendChild(document.createTextNode('\n'));
        chat.scrollTop = chat.scrollHeight;
    }
</script>
</body>
</html>